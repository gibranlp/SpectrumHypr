#!/bin/bash
# _____             _                 _____ _____ 
#|   __|___ ___ ___| |_ ___ _ _ _____|     |   __|
#|__   | . | -_|  _|  _|  _| | |     |  |  |__   |
#|_____|  _|___|___|_| |_| |___|_|_|_|_____|_____|
#      |_|   
# SpectrumOS - Embrace the Chromatic Symphony!
# By: gibranlp <thisdoesnotwork@gibranlp.dev>
# MIT licence 
# 
#
set -euo pipefail

WALL_DIR="$HOME/Pictures/Wallpapers"
IMG="${1:-}"

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing: $1"; exit 1; }; }
need wal
need swww

# Pick an image if none passed
if [[ -z "$IMG" ]]; then
  mapfile -t imgs < <(find "$WALL_DIR" -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' \))
  [[ ${#imgs[@]} -eq 0 ]] && { echo "No images in $WALL_DIR"; exit 1; }
  IMG="${imgs[RANDOM % ${#imgs[@]}]}"
fi
[[ -f "$IMG" ]] || { echo "File not found: $IMG"; exit 1; }

# Ensure sane runtime env
: "${XDG_RUNTIME_DIR:="/run/user/$(id -u)"}"
: "${WAYLAND_DISPLAY:="$(basename "$(ls -1 $XDG_RUNTIME_DIR/wayland-* 2>/dev/null | head -n1 || echo wayland-1)")"}"

NS="$WAYLAND_DISPLAY"   # e.g. wayland-1

# Start swww-daemon for this namespace if needed
if ! pgrep -x swww-daemon >/dev/null; then
  swww-daemon --namespace "$NS" >/dev/null 2>&1 &
  sleep 0.3
fi

# Generate pywal colors
wpg -s "$IMG"

# Set wallpaper (applies to all outputs in modern swww)
swww img "$IMG" \
  --namespace "$NS" \
  --transition-type outer \
  --transition-duration 1.5 \
  --transition-fps 75

# Now it's safe to retire other daemons (optional)
pkill -x hyprpaper 2>/dev/null || true
pkill -x swaybg 2>/dev/null || true
pkill -x wpaperd 2>/dev/null || true
pkill -x mpvpaper 2>/dev/null || true

# Light refresh for bars/themes (optional)
# Waybar: reload if running, else start exactly one instance
# replace your Waybar block with this
if pgrep -x waybar >/dev/null; then
  waybar-msg cmd reload >/dev/null 2>&1 || true
else
  nohup waybar >/dev/null 2>&1 & disown
fi


hyprctl reload 2>/dev/null || true

echo "âœ“ set on $NS: $IMG"